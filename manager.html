<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-600">üë§ Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>
      <div class="space-x-2">
        <button onclick="showTab('user')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded">T√†i kho·∫£n</button>
        <button onclick="showTab('log')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-1 rounded">üìù Nh·∫≠t k√Ω</button>
      </div>
    </div>

    <!-- Tab: User -->
    <div id="userTab">
      <input type="text" id="searchInput" oninput="renderUserList()" placeholder="T√¨m ki·∫øm theo t√™n..." 
             class="w-full border px-4 py-2 rounded mb-4" />
      <div id="userList" class="divide-y"></div>
    </div>

    <!-- Tab: Logs -->
    <div id="logTab" class="hidden">
      <div id="logList" class="space-y-6"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  const firebaseConfig = {
  apiKey: "AIzaSyDAtjOUgMkrZ0FRIaod0QV9b03qZZnlhu0",
  authDomain: "messend-online.firebaseapp.com",
  databaseURL: "https://messend-online-default-rtdb.firebaseio.com",
  projectId: "messend-online",
  storageBucket: "messend-online.appspot.com",
  messagingSenderId: "103927627337",
  appId: "1:103927627337:web:f5347fc34dd8de4ee00998"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let allUsers = [];
let logData = {};

function listenForUsers() {
  db.ref("users").on("value", snapshot => {
    allUsers = [];
    snapshot.forEach(child => {
      allUsers.push({ uid: child.key, ...child.val() });
    });
    renderUserList();
    renderLogList();
  });
}

function listenForLogs() {
  db.ref("logs").on("value", snapshot => {
    logData = snapshot.val() || {};
    renderLogList();
  });
}

function renderUserList() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const container = document.getElementById("userList");
  container.innerHTML = '';

  allUsers
    .filter(user => user.username.toLowerCase().includes(keyword))
    .forEach(user => {
      const div = document.createElement("div");
      div.className = "flex justify-between items-center px-4 py-3 hover:bg-gray-50";
      div.innerHTML = `
        <div>
          <p class="font-medium text-gray-800">${user.username}</p>
          <p class="text-xs text-gray-500">UID: ${user.uid}</p>
        </div>
        <button onclick="deleteUser('${user.uid}')" class="text-red-600 hover:underline text-sm">X√≥a</button>
      `;
      container.appendChild(div);
    });
}

function renderLogList() {
  const container = document.getElementById("logList");
  container.innerHTML = '';

  allUsers.forEach(user => {
    const log = logData[user.uid];
    if (log && log.text) {
      const div = document.createElement("div");
      div.className = "bg-yellow-50 border border-yellow-200 p-4 rounded shadow";
      div.innerHTML = `
        <h3 class="text-lg font-semibold text-gray-800 mb-2">${user.username}</h3>
        <pre class="text-gray-700 whitespace-pre-wrap">${log.text}</pre>
        <p class="text-xs text-gray-500 mt-2">C·∫≠p nh·∫≠t: ${new Date(log.timestamp).toLocaleString()}</p>
      `;
      container.appendChild(div);
    }
  });
}

function deleteUser(uid) {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n n√†y?")) return;

  const updates = {};
  updates["users/" + uid] = null;
  updates["logs/" + uid] = null;
  updates["friends/" + uid] = null;
  updates["friendRequests/" + uid] = null;

  db.ref("friends").once("value").then(snapshot => {
    snapshot.forEach(child => {
      if (child.hasChild(uid)) {
        updates[`friends/${child.key}/${uid}`] = null;
      }
    });

    return db.ref("friendRequests").once("value");
  }).then(snapshot => {
    snapshot.forEach(child => {
      if (child.hasChild(uid)) {
        updates[`friendRequests/${child.key}/${uid}`] = null;
      }
    });

    return db.ref().update(updates);
  }).then(() => {
    console.log("ƒê√£ x√≥a t√†i kho·∫£n v√† d·ªØ li·ªáu li√™n quan.");
  });
}

function showTab(tab) {
  document.getElementById("userTab").style.display = tab === 'user' ? 'block' : 'none';
  document.getElementById("logTab").style.display = tab === 'log' ? 'block' : 'none';
}

// Kh·ªüi ƒë·ªông theo th·ªùi gian th·ª±c
listenForUsers();
listenForLogs();

</script>

</body>
</html>
